#!/bin/sh

########################################################################
##
##  proxy-firewall-restrict
##  Configure Qubes firewall for use with a tunnel such as OpenVPN.
##
##  Note: For customization, add rules to a filename in firewall.d
##  other than '90_tunnel-restrict'.


groupadd -rf qvpn && sync

# Set firewall restriction policy

# Stop all leaks between downstream (vif+) and upstream (Internet eth0):
# 1 TODO
iptables -P FORWARD DROP
nft 'insert rule ip filter FORWARD oifname "eth0" counter drop'
nft 'insert rule ip filter FORWARD iifname "eth0" counter drop'

# 1 TODO
ip6tables -P FORWARD DROP
nft 'insert rule ip6 filter FORWARD oifname "eth0" counter drop'
nft 'insert rule ip6 filter FORWARD iifname "eth0" counter drop'

# Block INPUT from tunnel(s):
# 2 TODO
iptables  -P INPUT DROP
ip6tables -P INPUT DROP

# Allow established v6 traffic (v4 rule already present):
#nft 'add rule ip filter INPUT ct state established counter accept'
nft 'add rule ip6 filter INPUT ct state established counter accept'

# Disable icmp packets
if [ -e /var/run/qubes-service/vpn-handler-no-icmp ]; then
  # 2 TODO
  iptables  -D INPUT -p icmp -j ACCEPT  || true
  ip6tables -D INPUT -p icmp -j ACCEPT  || true
  nft 'insert rule ip filter OUTPUT oifname "eth0" ip protocol icmp counter drop'
  nft 'insert rule ip6 filter OUTPUT oifname "eth0" meta l4proto icmp counter drop'
else
  # 2 TODO
  iptables  -I OUTPUT -p icmp -m owner --gid-owner qvpn -j ACCEPT
  ip6tables -I OUTPUT -p icmp -m owner --gid-owner qvpn -j ACCEPT
fi

###-------------------------------------------------------------------###
# This section executed only if vpn-handler-egress service _not_ enabled:
if [ -e /var/run/qubes-service/vpn-handler-egress ]; then
    exit 0
fi

# Extra restriction prevents accidental communications from within VPN VM to net;
# The gid-owner rule requires net programs be run with group ID 'qvpn'
# to allow outbound traffic.
# 1 TODO
iptables -P OUTPUT DROP
nft 'insert rule ip filter OUTPUT oifname "lo" counter accept'
# 1 TODO
iptables -I OUTPUT -p all -o eth0 -m owner --gid-owner qvpn -j ACCEPT

# 1 TODO
ip6tables -P OUTPUT DROP
nft 'insert rule ip6 filter OUTPUT oifname "lo" counter accept'
# 1 TODO
ip6tables -I OUTPUT -p all -o eth0 -m owner --gid-owner qvpn -j ACCEPT

